<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<link rel="shortcut icon" href="https://oss.am-all.com.cn/asset/img/main/favicon.png">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ICF Editor</title>
	<script type="text/javascript" src="./js/crypto.js"></script>
	<script type="text/javascript" src="./js/FileSaver.min.js"></script>
	<style type="text/css">
		* {
			box-sizing: border-box;
		}
		
		html, body {
			margin: 0;
			padding: 0;
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
		}
		
		body {
			font-size: 12px;
		}
		
		/* 主容器 */
		.container {
			max-width: 1400px;
			margin: 0 auto;
			padding: 20px;
		}
		
		/* 标题 */
		.header {
			background: rgba(255, 255, 255, 0.95);
			border-radius: 12px;
			padding: 20px;
			margin-bottom: 20px;
			box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
		}
		
		.header h1 {
			margin: 0;
			font-size: 28px;
			background: linear-gradient(135deg, #667eea, #764ba2);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
		}
		
		/* 控制面板 - 保持原始结构 */
		#controls {
			background: rgba(255, 255, 255, 0.95);
			border-radius: 12px;
			padding: 20px;
			margin-bottom: 20px;
			box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
		}
		
		#controls label {
			display: inline-block;
			margin-right: 20px;
			cursor: pointer;
			user-select: none;
		}
		
		#controls input[type="checkbox"] {
			margin-right: 5px;
			vertical-align: middle;
		}
		
		#controls button {
			padding: 8px 16px;
			margin: 0 10px;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-size: 14px;
			font-weight: 500;
			transition: transform 0.2s, box-shadow 0.2s;
		}
		
		#ctrl_reset {
			background: #e5e7eb;
			color: #374151;
		}
		
		#ctrl_reset:hover {
			background: #d1d5db;
			transform: translateY(-1px);
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
		}
		
		#ctrl_export {
			background: linear-gradient(135deg, #667eea, #764ba2);
			color: white;
		}
		
		#ctrl_export:hover:not(:disabled) {
			transform: translateY(-1px);
			box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
		}
		
		#ctrl_export:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}
		
		.error {
			color: #ef4444;
			font-weight: 500;
			margin-top: 10px;
			margin-bottom: 0;
		}
		
		/* 主编辑区域 */
		#main {
			background: rgba(255, 255, 255, 0.95);
			border-radius: 12px;
			padding: 20px;
			box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
			display: flex;
			gap: 20px;
			min-height: 500px;
			position: relative;
		}
		
		/* 左侧编辑器 */
		.editor-wrapper {
			flex: 1;
			display: flex;
			flex-direction: column;
		}
		
		.section-label {
			font-size: 12px;
			font-weight: 600;
			color: #6b7280;
			text-transform: uppercase;
			margin-bottom: 8px;
			letter-spacing: 0.5px;
		}
		
		#editor {
			flex: 1;
			margin: 0;
			padding: 10px;
			font-family: 'Courier New', monospace;
			background: #f9fafb;
			border: 2px solid #e5e7eb;
			border-radius: 8px;
			overflow-y: auto;
		}
		
		#editor li {
			list-style-position: inside;
			font-size: 1.3em;
			margin: 0;
			padding: 10px 5px;
			border-bottom: 1px solid #e5e7eb;
			min-height: 2em;
			line-height: 1.5;
		}
		
		#editor li.error {
			background: #fef2f2;
			color: #dc2626;
		}
		
		/* 右侧Hex显示 */
		.dump-wrapper {
			flex: 1;
			display: flex;
			flex-direction: column;
		}
		
		#dump {
			flex: 1;
			margin: 0;
			padding: 10px;
			display: inline-block;
			line-height: 1.5em;
			white-space: pre;
			font-family: 'Courier New', monospace;
			background: #1e293b;
			color: #10b981;
			border-radius: 8px;
			overflow: auto;
			font-size: 0.9em;
		}
		
		#dump .error {
			color: #f87171;
		}
		
		/* 文件拖放 */
		#filedrop {
			display: none;
			position: fixed;
			width: 100%;
			height: 100%;
			left: 0;
			top: 0;
			z-index: 99999;
			background: rgba(102, 126, 234, 0.95);
			border: 1em dashed rgba(255, 255, 255, 0.5);
			transition: opacity 0.3s ease-out;
			opacity: 0;
		}
		
		#filedrop::before {
			content: "Drop ICF Here";
			position: absolute;
			top: calc(50% - 0.5em);
			width: 100%;
			font-size: 4em;
			display: block;
			font-family: sans-serif;
			text-align: center;
			color: white;
		}
		
		/* 移动端适配 */
		@media (max-width: 768px) {
			.container {
				padding: 10px;
			}
			
			.header h1 {
				font-size: 20px;
			}
			
			#controls button {
				display: block;
				width: 100%;
				margin: 10px 0;
			}
			
			#main {
				flex-direction: column;
			}
			
			.editor-wrapper, .dump-wrapper {
				width: 100%;
			}
			
			#editor, #dump {
				min-height: 300px;
				max-height: 400px;
			}
			
			#filedrop::before {
				font-size: 2em;
			}
		}
		
		/* 滚动条美化 */
		::-webkit-scrollbar {
			width: 8px;
			height: 8px;
		}
		
		::-webkit-scrollbar-track {
			background: #f1f1f1;
			border-radius: 4px;
		}
		
		::-webkit-scrollbar-thumb {
			background: #9ca3af;
			border-radius: 4px;
		}
		
		::-webkit-scrollbar-thumb:hover {
			background: #6b7280;
		}
	</style>
	<script type="text/javascript" src="./js/icfedit.js"></script>
</head>
<body>
	<div id="filedrop"></div>
	
	<div class="container">
		<div class="header">
			<h1>ICF Editor</h1>
		</div>
		
		<div id="controls">
			<label><input type="checkbox" id="ctrl_decrypt" checked/> Show Decrypted Dumps</label>
			<button id="ctrl_reset">Clear Editor</button>
			<button id="ctrl_export" disabled>Save ICF</button>
			<p class="error" id="errmsg"></p>
		</div>
		
		<div id="main">
			<div class="editor-wrapper">
				<div class="section-label">Editor</div>
				<ol id="editor" contenteditable>
					<li>SXXXACA0</li>
				</ol>
			</div>
			
			<div class="dump-wrapper">
				<div class="section-label">Hex Dump</div>
				<code id="dump" contenteditable>or paste xxd here...</code>
			</div>
		</div>
	</div>

	<script type="text/javascript">
		// Controls
		var decryptBtn = document.getElementById('ctrl_decrypt');
		decryptBtn.addEventListener('click', function() {
			if (!exportBtn.disabled) {
				renderDump(window.icfdata);
			}
		});
		var exportBtn = document.getElementById('ctrl_export');
		exportBtn.addEventListener('click', function() {
			var dlname = icf_infer_filename(window.icfdata) || 'ICF1';
			var dldata = icf_encrypt(window.icfdata);
			var dlblob = new Blob([dldata], {type: "application/octet-stream"});
			saveAs(dlblob, dlname);
		});
		document.getElementById('ctrl_reset').addEventListener('click', function() {
			if (confirm('Unsaved edits will be lost. Reset?')) {
				localStorage.removeItem('icfdata');
				location.reload();
			}
		})
		var errmsg = document.getElementById('errmsg');

		// File dropping
		var dropZone = document.getElementById('filedrop');

		function showDropZone(e) {
			if (e.dataTransfer.types[0] != 'Files') {
				return;
			}
			dropZone.style.display = "block";
			setTimeout(function() {
				dropZone.style.opacity = "0.8";
			}, 1);
		}
		function hideDropZone() {
			dropZone.style.opacity = "0.0";
			setTimeout(function() {
				dropZone.style.display = "none";
				dropZone.style.opacity = "0.0";
			},310);
		}

		function allowDrag(e) {
			if (e.dataTransfer.types[0] == 'Files') {
				e.dataTransfer.dropEffect = 'copy';
				e.preventDefault();
			}
		}

		function handleDrop(e) {
			e.preventDefault();
			hideDropZone();
			var xfer = e.dataTransfer;
			var files = [];
			if (xfer.items) {
				Array.from(xfer.items).forEach(function(f) {
					if (f.kind == 'file') {
						files.push(f.getAsFile());
					}
				})
			} else if (xfer.files) {
				files = Array.from(xfer.files);
			}
			files.forEach(processFile);
			console.log(files);
		}

		function processFile(file) {
			if (file.size > 0x2800) {
				file = file.slice(0,0x2800);
			}
			file.arrayBuffer().then(function(buffer) {
				var data = icf_decrypt(new Uint8Array(buffer));
				var error = icf_sanity_error(data);
				if (!error) {
					importData(data);
				} else {
					errmsg.innerText = error;
				}
			});
		}

		window.addEventListener('dragenter', showDropZone);
		dropZone.addEventListener('dragenter', allowDrag);
		dropZone.addEventListener('dragover', allowDrag);
		dropZone.addEventListener('dragleave', hideDropZone);
		dropZone.addEventListener('drop', handleDrop);

		// Editing
		window.icfdata = new Uint8Array(0x40);
		var dumpZone = document.getElementById('dump');
		var editZone = document.getElementById('editor');
		dumpZone.addEventListener('input', function() {
			var data = xxd_decode(dumpZone.innerText);
			if (!data) {
				exportBtn.disabled = true;
				errmsg.innerText = "Malformed Hex Dump";
				return;
			}
			if (!decryptBtn.checked) {
				data = icf_decrypt(data);
			} else if (icf_sanity_error(data)) {
				var trydec = icf_decrypt(data);
				if (!icf_sanity_error(trydec)) {
					data = trydec;
					renderDump(data);
				}
			}
			window.icfdata = data;
			renderEditor(data);
		});
		dumpZone.addEventListener('blur', function() {
			if (!exportBtn.disabled) {
				renderDump(window.icfdata);
				localStorage['icfdata'] = bin2hex(window.icfdata);
			}
		});

		editZone.addEventListener('input', function() {
			if (editZone.childElementCount == 0) {
				// Leave an empty entry
				editZone.innerHTML = '<li></li>';
				return;
			}
			var lines = [];
			for (var i = 0; i < editZone.children.length; i++) {
				var line = editZone.children[i].innerText.trim();
				if (line.indexOf('\n') != -1) {
					// Probably pasted. Re-layout
					lines = editZone.innerText.split('\n');
					editZone.innerHTML = '';
					for (var i = 0; i < lines.length; i++) {
						var li = document.createElement('li');
						li.innerText = lines[i].trim();
						editZone.appendChild(li);
					}
					break;
				}
				if (i != editZone.children.length-1 || line.length > 0) {
					lines.push(line);
				}
			}
			var entries = icf_encode(lines);
			var dumphtml = "";
			var hasError = false;
			for (var i = 0; i < entries.length; i++) {
				var entry = entries[i];
				if (entry instanceof Uint8Array) {
					// OK
					dumphtml += xxd_encode(entry, i * 0x40, '<br>');
					editZone.children[i].className = '';
				} else {
					// Error
					hasError = true;
					dumphtml += '<br><span class="error">' + entry + '</span><br><br><br>';
				}
			}
			exportBtn.disabled = hasError;
			if (!hasError) {
				window.icfdata = new Uint8Array(entries[0].buffer);
				renderDump(window.icfdata);
				localStorage['icfdata'] = bin2hex(window.icfdata);
			} else {
				dumpZone.innerHTML = dumphtml;
				errmsg.innerText = '';
			}
		});

		function renderEditor(data) {
			var entries = icf_decode(data);
			if (!entries || !entries.length) {
				errmsg.innerText = "";
				exportBtn.disabled = true;
				return false;
			}
			if (entries.error) {
				errmsg.innerText = entries.error;
				exportBtn.disabled = true;
				return false;
			}
			errmsg.innerText = "";
			if (entries.length != editZone.children.length) {
				editZone.innerHTML = "";
				for (var i = 0; i < entries.length; i++) {
					editZone.appendChild(document.createElement('li'));
				}
			}
			var hasError = false;
			for (var i = 0; i < entries.length; i++) {
				editZone.children[i].innerText = entries[i];
				editZone.children[i].className = entries[i][0] == '!' ? 'error' : '';
				hasError ||= entries[i][0] == '!';
			}
			exportBtn.disabled = hasError;
		}

		function renderDump(data) {
			if (!decryptBtn.checked) {
				data = icf_encrypt(data);
			}
			dumpZone.innerText = xxd_encode(data);
		}

		function importData(data) {
			renderDump(data);
			renderEditor(data);
			if (!exportBtn.disabled) {
				window.icfdata = data;
				localStorage['icfdata'] = bin2hex(window.icfdata);
			}
		}

		// Load from localStorage
		if (localStorage['icfdata']) {
			importData(hex2bin(localStorage['icfdata']));
		}
	</script>
</body>
</html>